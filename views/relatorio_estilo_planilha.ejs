<%- include('partials/header') %>
<%
  // helper para formatar datas em dd/mm/aaaa
  function fmtData(data) {
    if (!data) return '-';

    // Se vier como Date, converte para string YYYY-MM-DD primeiro:
    if (data instanceof Date) {
      const y = data.getFullYear();
      const m = String(data.getMonth() + 1).padStart(2, '0');
      const d = String(data.getDate()).padStart(2, '0');
      return `${d}/${m}/${y}`;
    }

    // Se vier como string 'YYYY-MM-DD' ou 'YYYY-MM-DDTHH:MM:SS...'
    const m = /^(\d{4})-(\d{2})-(\d{2})/.exec(String(data));
    if (m) {
      const [, y, mo, d] = m;
      return `${d}/${mo}/${y}`;
    }

    // Fallback (último recurso)
    try {
      const dt = new Date(data);
      const dia = String(dt.getDate()).padStart(2, '0');
      const mes = String(dt.getMonth() + 1).padStart(2, '0');
      const ano = dt.getFullYear();
      return `${dia}/${mes}/${ano}`;
    } catch {
      return String(data);
    }
  }
%>
<% const isPrint = (typeof print !== 'undefined') ? !!print : false; %>

<style>
  .wrap {
    display: grid;
    grid-template-columns: 1fr 320px; /* tabela | resumo */
    gap: 16px;
    align-items: start;
  }
  table { border-collapse: collapse; width: 100%; font-size: 12px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }

  @media print {
    @page { size: A4 landscape; margin: 10mm; }
    body { zoom: 0.90; } /* ajuste 0.80–0.95 se precisar caber */
    .no-print { display: none !important; }
  }
</style>

<% if (isPrint) { %>
<style>
  body { background: #fff; }
</style>
<% } %>


<h1 class="mb-4">Relatório de Jornada</h1>

<!-- Filtros -->
<form method="GET" action="/jornada/relatorio_avancado" class="row g-3 mb-5">
  <div class="col-md-4">
    <label for="id_funcionario" class="form-label no-print">Funcionário:</label>
    <select name="id_funcionario" id="id_funcionario" class="form-select no-print" required>
      <option value="">Selecione</option>
      <% funcionarios.forEach(f => { %>
        <option value="<%= f.id %>" <%= filtros && filtros.id_funcionario == f.id ? 'selected' : '' %>><%= f.nome %></option>
      <% }) %>
    </select>
  </div>

  <div class="col-md-3">
    <label for="data_inicio" class="form-label no-print">De:</label>
    <input type="date" name="data_inicio" id="data_inicio" class="form-control no-print" required value="<%= filtros ? filtros.data_inicio : '' %>">
  </div>

  <div class="col-md-3">
    <label for="data_fim" class="form-label no-print">Até:</label>
    <input type="date" name="data_fim" id="data_fim" class="form-control no-print" required value="<%= filtros ? filtros.data_fim : '' %>">
  </div>

  <div class="col-md-2 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100 no-print">Gerar Relatório</button>
  </div>
</form>

<% if (relatorio.length > 0) { %>

  <h4 class="mb-3">Funcionário: <%= funcionario.nome %></h4>
  <div class="d-flex gap-2 align-items-center flex-wrap mb-3" style="margin-bottom:12px; display:flex; gap:8px;">
     <div class="me-auto mb-2 mb-sm-0">
    <span class="fw-bold">Período:</span>
    <%= fmtData(data_inicio) %> — <%= fmtData(data_fim) %>
  </div>
 <!-- <h5 class="mb-0">Período: <%= fmtData(data_inicio) %> até <%= fmtData(data_fim) %></h5>--> 
    <!-- Botões de exportação -->
      <div class="d-flex gap-2">
  <a class="btn btn-sm btn-success no-print px-2 py-2 lh-1"
     href="/jornada/excel?id_funcionario=<%= filtros.id_funcionario %>&data_inicio=<%= filtros.data_inicio %>&data_fim=<%= filtros.data_fim %>">
    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
  </a>

  <a class="btn btn-sm btn-primary no-print px-2 py-2 lh-1"
     href="/jornada/pdf?id_funcionario=<%= filtros.id_funcionario %>&data_inicio=<%= filtros.data_inicio %>&data_fim=<%= filtros.data_fim %>">
    <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
  </a>
  </div>
</div>

  <!-- Tabela de Jornadas -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-striped align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Data</th>
          <th>Dia</th>
          <th>Entrada 1º T.</th>
          <th>Saída 1º T.</th>
          <th>Entrada 2º T.</th>
          <th>Saída 2º T.</th>
          <th>Horas Trabalhadas</th>
          <th>Horas Extras</th>
          <th>Horas Restantes</th>
          <th>Folga 1º T.</th>
          <th>Folga 2º T.</th>
        </tr>
      </thead>
      <tbody>
        <% relatorio.forEach(r => { %>
          <tr>
            <td><%= fmtData(r.data) %></td>
            <td><%= r.dia %></td>
            <td><%= r.entrada || '-' %></td>
            <td><%= r.saida_intervalo || '-' %></td>
            <td><%= r.retorno_intervalo || '-' %></td>
            <td><%= r.saida || '-' %></td>
            <td><%= r.horas_trabalhadas || '-' %></td>
            <td><%= r.horas_extras || '-' %></td>
            <td><%= r.horas_restantes || '-' %></td>
            <td><%= r.folga_primeiro_periodo === 'S' ? '✔️' : '' %></td>
            <td><%= r.folga_segundo_periodo === 'S' ? '✔️' : '' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Resumo -->
  <h4 class="mb-3">Resumo Geral</h4>
  <table class="table table-bordered w-100">
    <tbody>
      <tr><th>Horas Trabalhadas</th><td><%= resumo.total_trabalhadas %></td></tr>
      <tr><th>Horas Extras</th><td><%= resumo.total_extras %></td></tr>
      <tr><th>Horas Restantes</th><td><%= resumo.total_restantes %></td></tr>
      <tr><th>Saldo</th><td><%= resumo.saldo %></td></tr>
      <tr><th>Salário Base</th><td>R$ <%= resumo.salario_base %></td></tr>
      <tr><th>Valor Hora</th><td>R$ <%= resumo.valor_hora %></td></tr>
      <tr><th>Valor Hora Extra</th><td>R$ <%= resumo.valor_hora_extra %></td></tr>
      <tr><th>Valor de Horas Extras</th><td>R$ <%= resumo.valor_horas_extras_rs %></td></tr>
      <tr><th>DSR sobre Extras</th><td>R$ <%= resumo.dsr %></td></tr>
    </tbody>
  </table>



<% } else { %>

  <div class="alert alert-warning mt-4" role="alert">
    <strong>Selecione um funcionário e um período para gerar o relatório.</strong>
  </div>

<% } %>

<%- include('partials/footer') %>
